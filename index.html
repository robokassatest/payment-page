<script>
    // ================== НАСТРОЙКИ ==================
    const MERCHANT_LOGIN = "testoviymagazin21";
    const MERCHANT_PASS1 = "rk3kAvm876krf8ppFdpi";
    const PRODUCT_NAME = "Разработка сайта";
    const TAX_RATE = "none";
    // ===============================================

    function processPayment() {
        const sum = document.getElementById('paymentSum').value;
        if (!sum || sum < 1) {
            alert("Введите корректную сумму!");
            return;
        }

        // 1. Формируем чек (сумму как число, не строку!)
        const receipt = {
            items: [{
                name: PRODUCT_NAME,
                quantity: 1,
                sum: Number(sum), // Важно: число, а не строка
                payment_method: 'full_payment',
                payment_object: 'service',
                tax: TAX_RATE
            }]
        };

        // 2. Кодируем параметры (ТОЛЬКО ОДИН РАЗ)
        const receiptString = JSON.stringify(receipt);
        const receiptEncoded = encodeURIComponent(receiptString); // Однократное кодирование
        const invId = 0;
        
        // 3. Формируем подпись (пробуем оба варианта)
        const signatureString1 = `${MERCHANT_LOGIN}:${sum}:${invId}:${receiptEncoded}:${MERCHANT_PASS1}`;
        const signatureString2 = `${MERCHANT_LOGIN}:${sum}:${invId}::${MERCHANT_PASS1}`; // Без Receipt
        const crc1 = CryptoJS.MD5(signatureString1).toString();
        const crc2 = CryptoJS.MD5(signatureString2).toString();

        // 4. Пробуем оба варианта URL
        const paymentUrl1 = 
            `https://auth.robokassa.ru/Merchant/Index.aspx?` +
            `MrchLogin=${MERCHANT_LOGIN}&` +
            `OutSum=${sum}&` +
            `InvId=${invId}&` +
            `Receipt=${receiptEncoded}&` +
            `Desc=-&` +
            `IsTest=1&` +
            `SignatureValue=${crc1}`;
            
        const paymentUrl2 = 
            `https://auth.robokassa.ru/Merchant/Index.aspx?` +
            `MrchLogin=${MERCHANT_LOGIN}&` +
            `OutSum=${sum}&` +
            `InvId=${invId}&` +
            `Desc=-&` +
            `IsTest=1&` +
            `SignatureValue=${crc2}`;

        // Пробуем сначала первый вариант, если ошибка - второй
        console.log("Пробуем URL с Receipt:", paymentUrl1);
        window.location.href = paymentUrl1;
        
        // Если не сработает, через 3 сек пробуем без Receipt
        setTimeout(() => {
            console.log("Пробуем URL без Receipt:", paymentUrl2);
            window.location.href = paymentUrl2;
        }, 3000);
    }
</script>
